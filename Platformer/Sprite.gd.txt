extends KinematicBody2D

#signals 
signal  grounded_updated(is_grounded)#camera work

#declare variables here
const SPEED = 70 #in pixels 
const GRAVITY = 15 
const JUMP_SPEED = -350
const FLOOR = Vector2(0,-1)
const FIREBALL = preload("res://FireATK.tscn")

#speed
var velocity = Vector2()
#ground
var on_ground = true #initialize for anytime in air

var is_grounded
#attacks
var is_attacking = false
#jumping animation
var is_jumping = true

func _physics_process(_delta): #Character movement here
	
	#X plane movement
	if Input.is_action_pressed("ui_right"):   
		if is_attacking == false:
			velocity.x = SPEED	
			$AnimatedSprite.play("Run")	
			$AnimatedSprite.flip_h = false
			if sign($Position2D.position.x) == -1:
				$Position2D.position.x *= -1
	elif Input.is_action_pressed("ui_left"):
		if is_attacking == false:
			velocity.x = -SPEED		
			$AnimatedSprite.play("Run")
			$AnimatedSprite.flip_h = true
			if sign($Position2D.position.x) == 1:
				$Position2D.position.x *= -1
	else:
		velocity.x = 0
			
	#Jump movement
	if Input.is_action_pressed("ui_up") && is_on_floor():
		if is_attacking == false || on_ground ==true:
				velocity.y = JUMP_SPEED
				on_ground = false
				is_jumping = true
				
	#FALL GRAVITY
	velocity.y += GRAVITY 

	if is_on_floor():
		on_ground = true
	else:
		if is_attacking == false:
			on_ground = false 
			if velocity.y < 0:
				$AnimatedSprite.play("Jump")
			else:
				$AnimatedSprite.play("Fall")
	
	#move and slide (linear velocity, floor normal) where floor normal defines floors and walls  (0,-1) is top of floor (0,1) is for ceiling
	velocity = move_and_slide(velocity, FLOOR) #set to velocity to start at the current velocity when looping
				
	#Animations for floor
	if is_on_floor():
		#IDLE
		if velocity.x == 0 && is_attacking == false:
			$AnimatedSprite.play("Idle")
		#RIGHT MOVEMENT
		if velocity.x > 0:
			if is_jumping == true:
				$AnimatedSprite.play("Jump")
				$AnimatedSprite.flip_h = false
				
		#LEFT MOVEMENT
		if velocity.x < 0:
			if is_jumping == true:
				$AnimatedSprite.play("Jump")
				$AnimatedSprite.flip_h = true
	
	#CAMERA
	#For camera to not shake when jumping 
	var was_grounded = is_grounded
	is_grounded = is_on_floor()
	
	if was_grounded == null || is_grounded != was_grounded:
		emit_signal("grounded_updated", is_grounded)
	 
	
	#Fire Attack
	if Input.is_action_just_pressed("ui_select") && is_attacking == false:
		if is_on_floor():
			velocity.x = 0
		is_attacking = true
		$AnimatedSprite.play("Attack")	
		#check attack cd
		var now = OS.get_ticks_msec()
		var fireball = FIREBALL.instance() #create instance of fireball that has properties of fireball scenee( movement, and animation)
		if sign($Position2D.position.x) == 1: #if fireball is coming out of the right side 
			fireball.set_fireball_direction(1) #set direction to right
		else:
			fireball.set_fireball_direction(-1) #else set direction to left 
		get_parent().add_child(fireball) #add fireball as child of parent 
		fireball.position = $Position2D.global_position
			
		
		
			
				


func _on_AnimatedSprite_animation_finished():
	is_attacking = false 

		
		
